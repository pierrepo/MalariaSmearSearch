{% extends "skeleton.html" %}

{% block title %}Blood smear upload{% endblock %}

{% block head %}
{{super()}}
<link rel="stylesheet" type="text/css" href="{{url_for('static', filename='css/form.css')}}" />
{% endblock %}

{% block content %}

        {% if form.errors %}
            <p class="error"><strong>Unable to upload image. See error messages below.</strong>
        {% endif %}

        {% from "_formhelpers.html" import render_field %}
        <form method="POST" onsubmit="" action="{{url_for('upload')}}"  enctype="multipart/form-data">
        <fieldset class="field-upload">
            <legend id="legend-upload-mandatory">Blood smear details</legend>
            <p id="info-mandatory">Fields with <span style="color:red;">*</span> are mandatory</p>
          <dl>
            {{ render_field(form.sample) }}
            {{ render_field(form.smear_type) }}
            {{ render_field(form.license) }}
            {{ render_field(form.provider) }}
        </fieldset>
        <fieldset class="field-upload">
            <legend id="legend-upload-optional">Complementary details</legend>
            {{ render_field(form.comment) }}
            {{ render_field(form.magnification) }}

            {{ render_field(form.patient_ref) }}
            <div id="result"></div>

            <div id = 'add_patient' class="hidden">
                {{ render_field(form.patient_year_of_birth) }}
                {{ render_field(form.patient_gender) }}
                {{ render_field(form.patient_city) }}
                {{ render_field(form.patient_country) }}
            </div>

          </dl>
        </fieldset>
          {{ form.submit }}
          {{ form.hidden_tag() }}


        </form>


{% endblock %}



{% block imports %}
    {{super()}}

    <script>

        $("#patient_ref").focusout(function() {
            var textboxvalue = $('input[name=patient_ref]').val();

            if( $(this).val() ) {
                // I have not found an error handler for get json ajax,
                // that is why I use the more verbose ajax method :
                $.ajax( {
                    type: "GET",
                    dataType: 'json',
                    url: Flask.url_for("get_patient", {"institution": "{{current_user.original_institution.name}}", "patient_ref":textboxvalue}),
                    //data: {txt1: textboxvalue},
                    success: function(result){
                        $("#result").text(result);
                        $("#add_patient").addClass('hidden');
                    },
                    error: function (xhr) { //XMLHttpRequest
                        //Here the status code can be retrieved like;
                        alert(xhr.status);
                        //The message added to Response object in Controller can be retrieved as following.
                        alert(xhr.responseText); // http://stackoverflow.com/a/450540
                        $("#add_patient").removeClass('hidden');
                    },
                });
            }
        });
        // TODO :
        // http://stackoverflow.com/questions/16627964/how-do-you-send-an-ajax-request-every-time-that-a-form-input-field-changes/16628110#16628110

    </script>

{% endblock %}
